var FormBuilder=function(formIdentifier){var obj={success:true,emailRegex:/^\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}$/,passwordRegex:/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\#\!])?.{3,15}$/,formElement:"",formIdentifier:formIdentifier,response:false,rules:{},fields:{},fields_var_name:"",};obj.formIdentifier=formIdentifier;obj.loadingClosure=function(){};obj.construct=function(){if(obj.formElement==""){$(document).one("mouseover","form[data-identifier="+obj.formIdentifier+"]",function(){obj.formElement=$(this);});}if(obj.formElement==""){$(document).one("keydown","form[data-identifier="+obj.formIdentifier+"]",function(){obj.formElement=$(this);});}if(obj.formElement==""){$(document).one("submit","form[data-identifier="+obj.formIdentifier+"]",function(){obj.formElement=$(this);});}obj.fields_var_name=obj.formIdentifier+"_fields";var x=window[obj.fields_var_name];if(typeof x!="undefined"){obj.fields=JSON.parse(window[obj.fields_var_name]);}obj.activateCaptchaRefresh();};obj.activateCaptchaRefresh=function(){$("#"+obj.formIdentifier+" a[data-do=refresh-captcha]").on("click",function(){var a=$(this);a.prev("img").attr("src","/assets/images/ajax-loader.gif");$.get("/membership/captcha_refresh",{},function(res){res=JSON.parse(res);a.prev("img").attr("src",res.image_url);a.parent("div").find("input[type=hidden]").val(res.image_id);});return false;});};obj.construct();obj.setSuccess=function(res){if(obj.success==true){obj.success=res;}};obj.setError=function(ref,msg,input){obj.setSuccess(false);if(typeof input=="string"){if(obj.fields.hasOwnProperty(input)){input=$(obj.formElement).find("*[name="+input+"]");}}var err=$(document.createElement("div")).attr({"class":"form-builder-error","ref":ref}).html(msg).hide();input.parent("div").append(err.fadeIn());};obj.removeError=function(ref,input){input.parent("div").find("div[ref="+ref+"]").fadeOut().remove();};obj.validateEmail=function(emailInput){var ref="emailError";if(!obj.emailRegex.test(emailInput.val())){obj.setError(ref,"Invalid email address",emailInput);}};obj.validatePassword=function(passwordInput){var ref="passwordError";if(!obj.passwordRegex.test(passwordInput.val())){obj.setError(ref,"Password must be minimum 3 characters having at least 1 digit and 1 small letter 1 capital letter.",passwordInput);}};obj.requiredCheck=function(inputField,label){var ref="required";if(inputField.attr("type")=="radio"||inputField.attr("type")=="checkbox"){if(!inputField.is(":checked")){obj.setError(ref,"This field is required.",inputField);}}else{if(inputField.val()===null||inputField.val()===""){obj.setError(ref,"The "+label+" field is required.",inputField);}}};obj.checkMatch=function(second,first){var ref="matches";secondObj=$(obj.formElement).find("input[name="+second+"]");firstObj=$(obj.formElement).find("input[name="+first+"]");if(secondObj.val()!=firstObj.val()){obj.setError(ref,"It doesn't match "+obj.fields[first].label+".",secondObj);}};obj.minLen=function(inputName,len){var ref="minlen";inputObj=$(obj.formElement).find("*[name="+inputName+"]");if(inputObj.val().length<len){obj.setError(ref,"Must be at least "+len+" characters.",inputObj);}};obj.maxLen=function(inputName,len){var ref="minlen";inputObj=$(obj.formElement).find("*[name="+inputName+"]");if(inputObj.val().length>len){obj.setError(ref,"Must be maximum "+len+" characters.",inputObj);}};obj.validateRules=function(input){if(obj.hasOwnProperty("rules")){var rules=obj.rules;if(obj.fields.hasOwnProperty($(input).attr("name"))){var field_name=$(input).attr("name");var label_text=obj.fields[field_name].label;var rules=obj.fields[field_name].rules;var str_split=rules.split("|");if(str_split.length>0){for(var i in str_split){if(str_split[i]=="required"){obj.requiredCheck($(input),label_text);}if(str_split[i]=="validEmail"){obj.validateEmail($(input));}if(/^matches/i.test(str_split[i])){var res=str_split[i].match(/matches\((.*?)\)/i);if(res[1] in obj.fields){obj.checkMatch($(input).attr("name"),res[1]);}}if(/^minlen/i.test(str_split[i])){var res=str_split[i].match(/minlen\((.*?)\)/i);if(res[1].length>0){obj.minLen($(input).attr("name"),res[1]);}}if(/^maxlen/i.test(str_split[i])){var res=str_split[i].match(/minlen\((.*?)\)/i);if(res[1].length>0){obj.maxLen($(input).attr("name"),res[1]);}}}}}}};obj.isValid=function(){obj.success=true;$(obj.formElement).find(".form-builder-error").fadeOut().remove();for(var field_name in obj.fields){var field_info=obj.fields[field_name];var label_text=field_info.label;obj.validateRules($(obj.formElement).find("*[name="+field_name+"]"));}var passwords=$(obj.formElement).find("input[type=password]");for(var i=0;i<passwords.length;i++){obj.validatePassword($(passwords[i]));}return obj.success;};obj.setLoading=function(closure){if(typeof closure==="function"){obj.loadingClosure=closure;}};obj.checkAjax=function(){if($(obj.formElement).data("ajax")==1){return true;}return false;};obj.setResponse=function(json){obj.response=json;};obj.ajaxPost=function(closure){var xmlhttp;if(window.XMLHttpRequest){xmlhttp=new XMLHttpRequest();}else{xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");}xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200){obj.setResponse(xmlhttp.responseText);if(typeof closure==="function"){closure(xmlhttp.responseText);}}};xmlhttp.open("POST",$(obj.formElement).attr("action"),false);xmlhttp.setRequestHeader("X-Requested-With","XMLHttpRequest");xmlhttp.send(new FormData($(obj.formElement).get(0)));};obj.processErrorsResponse=function(errors){for(var i in errors){if(i!=""){var input=$(obj.formElement).find("*[name="+i+"]");obj.setError("autoMsg",errors[i],input);}}};obj.processMessagesResponse=function(messages){var msgWrapper=obj.formIdentifier+"-messages";$("#"+msgWrapper).html("");var msgsContainer=$(document.createElement("div")).attr("id",msgWrapper).addClass("form-builder-messages");if($.isArray(messages)){if(messages.length>0){for(var i in messages){var msg=$(document.createElement("div")).html(messages[i]);$(msgsContainer).append(msg);}$(obj.formElement).parent("div").before(msgsContainer);}}else{if(messages.length>0){var msg=$(document.createElement("div")).html(messages);$(msgsContainer).append(msg);$(obj.formElement).parent("div").before(msgsContainer);}}};obj.createElement=function(tag,_class){var el=$(document.createElement(tag)).addClass(_class);return el;};obj.addNewRow=function(){var row=obj.createElement("div","form-builder-row");return row;};obj.addNewColumn=function(label,input,name,type,value,rules){var col=obj.createElement("div","form-builder-grid-10 form-builder-column");var labelWrapper=obj.createElement("div","form-builder-label-wrapper");var labelEl=obj.createElement("label");if(/(required)/i.test(rules)){var star=$(obj.createElement("span","required-start")).html("* ");labelWrapper.html(star);}labelEl.append(label);labelWrapper.append(labelEl);var fieldWrapper=obj.createElement("div","form-builder-field-wrapper");if(input=="input"){if(type=="text"||type=="password"||type=="hidden"||type=="button"){var inputEl=$(obj.createElement("input")).attr({name:name,type:type}).val(value);}else{if(type=="radio"||type=="checkbox"){}}}else{if(input=="select"){}else{if(input=="textarea"){}}}fieldWrapper.append(inputEl);col.append(labelWrapper);col.append(fieldWrapper);return col;};obj.autoAddNew=function(list){for(var i in list){var row=obj.addNewRow();if(list[i].input.type=="select"){var input="select";}else{if(list[i].input.type=="textarea"){var input="textarea";}else{var input="input";}}var col=obj.addNewColumn(list[i].label,input,list[i].input.name,list[i].input.type,list[i].input.value,list[i].rules);row.append(col);$(obj.formElement).find("*[type=submit]").parents(".form-builder-row").before(row);if(list[i].hasOwnProperty("rules")){obj.rules[list[i].input.name]=list[i].rules;}}};obj.whenSubmit=function(closureAfter,closureBefore){obj.closureAfter=closureAfter;obj.closureBefore=closureBefore;if(typeof obj.fields=="undefined"){console.log(" Couldn't parse form jsObj : "+obj.fields_var_name);obj.fields=JSON.parse(window[obj.fields_var_name]);}$(document).on("submit","form#"+obj.formIdentifier,function(){console.log(obj.formIdentifier+" -> submitting");$(".form-builder-messages").remove();if(obj.isValid()){if(obj.checkAjax()){var execute=true;if(typeof obj.closureBefore==="function"){execute=obj.closureBefore();}if(execute&&typeof obj.closureAfter=="function"){obj.ajaxPost(function(res){obj.closureAfter(res);res=JSON.parse(res);if(res.hasOwnProperty("redirect")){window.location.replace(res.redirect);}if(res.hasOwnProperty("errors")){obj.processErrorsResponse(res.errors);}if(res.hasOwnProperty("message")){obj.processMessagesResponse(res.message);}if(res.hasOwnProperty("form_builder")){if(res.formBuilder.hasOwnProperty("new")){obj.autoAddNew(res.formBuilder["new"]);}}});}return false;}return true;}return false;});};return obj;};

